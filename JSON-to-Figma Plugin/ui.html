<!-- DROP AREA -->
<main class="wrapper">
  <div id="drop-area">
    <div style="margin: auto; width: 100%;">

      <div id="drop-area-not-uploaded">
        <label class="btn btn-primary">
          <input id="file-input" type="file" multiple />
          Upload JSON file
        </label>
      </div>

      <div id="drop-area-uploaded">
        <div id="file-name-wrap">
          <svg
            style="width: 16px; height: 20px;"
            fill="none"
            viewBox="0 0 16 20"
          >
            <path
              fill="#1BC47D"
              stroke="#1BC47D"
              d="M.5.5h10.777L15.5 5.192V19.5H.5V.5z"
            />
            <path stroke="#fff" d="M4.198 9.91l2.72 2.72 4.693-4.694" />
          </svg>
          <span class="body-text" id="file-name">file</span>
        </div>
        <button class="btn btn-secondary" id="reset-file-button">Reset</button>
      </div>
    </div>
  </div>
  <div id="drop-area-info">
    <p class="caption-text" style="margin-top: 16px; margin-bottom: 8px;">
      Your JSON file should have a
      <span id="show-file-structure">certain structure</span> to be readable.
    </p>
    <img id="drop-area-info-image" src="https://cdn.glitch.com/604ccd24-6c39-4492-b5ee-72a22eb071c0%2Fjson-example.png"/>
  </div>
  <!-- HIDDEN AREA -->
  <section id="hidden-area">
    <!-- ACTIONS AREA -->
    <section class="section" id="actions-area">
      <div id="actions-area-string">
        <h2 class="small-header-text">String items</h2>
        <div id="string-actions"></div>
      </div>
    </section>
    <!-- FIND IN SECTIONS AREA -->
    <section class="section" id="options-area">
      <h2 class="small-header-text">Find and populate</h2>

      <section class="sub-section">
        <div class="radio-btn">
          <input
            type="radio"
            checked
            name="populate-mode"
            id="only-selected-chk"
          />
          <label for="only-selected-chk" class="body-text"
            >Only selected layers</label
          >
        </div>
        <p class="caption-text">
          You can populate layers deeply nested in a group. To do so, manualy
          rename a layer you want to populate
        </p>
      </section class="sub-section">

      <section class="sub-section">
        <div class="radio-btn">
          <input type="radio" name="populate-mode" id="layer-name-chk" />
          <label for="layer-name-chk" class="body-text"
            >Find by layer name</label
          >
        </div>
        <p class="caption-text">
          You can populate layers deeply nested in a group. To do so, manualy
          rename a layer you want to populate.
        </p>
      </section>

      <section>
        <div class="radio-btn">
          <input type="radio" name="populate-mode" id="string-template-chk" />
          <label for="string-template-chk" class="body-text"
            >Find by string templates</label
          >
        </div>
        <p class="caption-text">
          You can populate layers deeply nested in a group. To do so, manualy
          rename a layer you want to populate.
        </p>
      </section>
    </section>
    <!-- RANDOM AREA -->
    <section class="section" id="random-area" style="padding-bottom: 0">
      <div class="checkbox-btn">
        <input type="checkbox" id="random-paste-chk" />
        <label for="random-paste-chk" class="body-text">Random order</label>
      </div>
      <p class="caption-text" style="margin-bottom: 0">
        All selected items will be filled in a random order.
      </p>
    </section>
  </section>
</main>

<!-- STYLES -->
<style>
  html {
    box-sizing: border-box;
  }
  *, *:before, *:after {
    box-sizing: border-box;
  }
  body {
    overflow-x: hidden;
    user-select: none;
  }
  input[type="checkbox"],
  input[type="radio"] {
    display: none;
  }
  .wrapper {
    display: flex;
    flex-direction: column;
  }
  .body-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
  }
  .caption-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
    color:rgba(0, 0, 0, 0.5)
  }
  .small-header-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-size: 11px;
    font-weight: 600;
    margin: 0 0 16px;
  }
  .btn {
    display: inline-block;
    flex-shrink: 0;
    margin: 1px 0 1px 0;
    padding: 6px 16px;
    border: 2px solid transparent;
    border-radius: 6px;
    outline: none;
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
    letter-spacing: 0.01em;
  }
  /* RADIO */
  .radio-btn label {
    padding-left: 22px;
    display: inline-block;
    position: relative;
    line-height: 1.3;
  }
  .radio-btn input[type="radio"] + label:before {
    content: "";
    display: block;
    width: 12px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid rgba(0, 0, 0, 0.8);
    background: #fff;
    border-radius: 50px;
  }
  .radio-btn input[type="radio"]:checked + label:after {
    content: "";
    display: block;
    width: 6px;
    height: 6px;
    background: #01385f;
    position: absolute;
    border-radius: 50%;
    top: 3px;
    left: 3px;
  }
  /* CHECKBOX */
  .checkbox-btn label {
    padding-left: 34px;
    line-height: 1.3;
    display: inline-block;
    position: relative;
  }
  .checkbox-btn input[type="checkbox"] + label:before {
    content: "";
    display: block;
    width: 24px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid rgba(0, 0, 0, 0.8);
    background: #fff;
    border-radius: 50px;
    transition: all 0.16s;
  }
  .checkbox-btn input[type="checkbox"] + label:after {
    content: "";
    display: block;
    width: 12px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid rgba(0, 0, 0, 0.8);
    background: #fff;
    border-radius: 50px;
    transition: all 0.16s;
  }
  .checkbox-btn input[type="checkbox"]:checked + label:before {
    background: #000;
  }
  .checkbox-btn input[type="checkbox"]:checked + label:after {
    left: 12px;
  }
  /*  */
  .btn-primary {
    color: #ffffff;
    background-color: #18a0fb;
    transition: background-color 0.12s ease;
  }
  .btn-primary:hover {
    background-color: #1290e4;
  }
  /*  */
  .btn-secondary {
    color: rgba(0, 0, 0, 0.8);
    background-color: transparent;
    border: 1px solid rgba(0, 0, 0, 0.8);
    transition: all 0.12s ease;
  }
  .btn-secondary:hover {
    border: 1px solid rgba(0, 0, 0, 0.6);
    background-color: rgba(0, 0, 0, 0.02);
  }
  /*  */
  .divider {
    margin: 0 -16px;
  }
  /*  */
  .section {
    user-select: none;
    padding: 20px 8px 16px;
  }
  .sub-section {
    user-select: none;
    margin: 0 0 24px;
  }
  /*  */
  #show-file-structure {
    color: black;
    text-decoration: underline;
    text-decoration-style: dotted;
  }
  #upload-icon {
    position: absolute;
    background-color: #18a0fb;
    width: 48px;
    height: 48px;
    border-radius: 100px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    transform: translate(-50%, calc(-50% + 0px)) scale(0);
    transform-origin: center bottom;
    transition: all 0.2s ease;
  }
  #upload-icon svg {
    width: 16px;
    height: 20px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  #upload-icon.highlight {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  /*  */
  #drop-area {
    overflow: hidden;
    position: relative;
    padding: 32px;
    min-height: 140px;
    margin: -8px -16px 0;
    background-color: #f3f3f3;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s ease;
    border-bottom: 1px solid rgba(0, 0, 0, 0.12);
  }
  #drop-area.highlight {
    background-color: #e7f4fc;
  }
  #drop-area.uploaded {
    background-color: #f3faf7;
    min-height: auto;
  }
  /*  */
  #drop-area-not-uploaded {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s ease;
  }
  #drop-area-not-uploaded input[type="file"] {
    display: none;
  }
  #drop-area-not-uploaded > span {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 12px;
  }
  #drop-area-not-uploaded.highlight {
    transform: translateY(-20px) scale(0.8);
    opacity: 0;
  }
  /*  */
  #file-name-wrap {
    display: flex;
    align-items: center;
  }
  #file-name {
    color: rgba(0, 0, 0, 0.8);
    margin-left: 10px;
    margin-right: 20px;
  }
  /*  */
  #drop-area-uploaded {
    display: none;
    width: 100%;
    justify-content: space-between;
  }
  /*  */
  #drop-area-info {
    font-family: "Inter", sans-serif;
    padding: 0 8px;
  }
  /*  */
  #drop-area-info-image {
    display: none;
    width: 100%;
    height: 320px;
    margin-top: 8px;
  }
  /*  */
  #options-area {
    margin: 0 -8px;
    padding: 16px 16px 16px;
    background: #f9f9f9;
    border-top: 1px solid rgba(0, 0, 0, 0.12);
    border-bottom: 1px solid rgba(0, 0, 0, 0.12);
  }
  /*  */
  #hidden-area {
    display: none;
  }
</style>

<!-- SCRIPTS -->
<script>
  // Variales
  const dropArea = document.getElementById("drop-area");
  const dropAreaInfo = document.getElementById("drop-area-info");
  const fileInput = document.getElementById("file-input");
  const fileName = document.getElementById("file-name");
  //
  const hiddenArea = document.getElementById("hidden-area");
  const actionArea = document.getElementById("actions-area");
  const actionAreaString = document.getElementById("actions-area-string");
  const stringActions = document.getElementById("string-actions");
  //
  const randomArea = document.getElementById("random-area");
  const randomCheckbox = document.getElementById("random-paste-chk");
  //
  const dropAreaNotUploaded = document.getElementById("drop-area-not-uploaded");
  const dropAreaUploaded = document.getElementById("drop-area-uploaded");
  //
  const stringTemplateCheckbox = document.getElementById("string-template-chk");
  const byLayerNameCheckbox = document.getElementById("layer-name-chk");
  //
  const showFileStructure = document.getElementById("show-file-structure");

  ////////////////////////////////

  // Util functions
  const getElementsHeight = (el) => {
    const arr = document.querySelector(el).children
    let allElemettsHeight = 0
    for (var item of arr) {
      allElemettsHeight = allElemettsHeight + item.getBoundingClientRect().height
    }
    return allElemettsHeight
  }

  const IsJsonString = (str) => {
    try {
      let json = JSON.parse(str);
      return typeof json === "object";
    } catch (e) {
      return false;
    }
  };

  const shuffle = (arr) => {
    const newArr = arr.slice();
    for (let i = newArr.length - 1; i > 0; i--) {
      const rand = Math.floor(Math.random() * (i + 1));
      [newArr[i], newArr[rand]] = [newArr[rand], newArr[i]];
    }
    return newArr;
  };

  const checkforNestedObj = (json) => {
    let newJSONArray = []

    json.map((JSONitem, g) => {
      let newSubObj = {}
      const firstArrayLevel = Object.values(JSONitem)
      firstArrayLevel.map((item, i) => {
        if (typeof item === "object") {
          const firstLevelObjectKeys = Object.keys(json[g])
          const firstLevelObjectValues = Object.values(json[g])
          const secondLevelObjectKeys = Object.keys(item)

          secondLevelObjectKeys.map((secondLevelKey, j) => {
            const secondLevelValues = Object.values(item)[j]

            if (typeof secondLevelValues === "object") {
              Object.keys(secondLevelValues).map((thirdLevelKey, f) => {
                newSubObj[`${firstLevelObjectKeys[i]}-${secondLevelKey}-${thirdLevelKey}`] = firstLevelObjectValues[i][secondLevelKey][thirdLevelKey]
              })
            } else {
              newSubObj[`${firstLevelObjectKeys[i]}-${secondLevelKey}`] = firstLevelObjectValues[i][secondLevelKey]
            }
          })
        } else {
          newSubObj[Object.keys(JSONitem)[i]] = item
        }
      })
      newJSONArray.push(newSubObj)
    })
    return newJSONArray
  }

  const clearTheData = () => {
    hiddenArea.style.display = "none";
    dropAreaInfo.style.display = "inline-block";
    stringActions.textContent = "";
  };

  const loadJSON = (obj) => {
    fileName.innerHTML = fileInput.files[0].name;

    dropAreaNotUploaded.style.display = "none";
    dropAreaUploaded.style.display = "flex";
    dropArea.classList.add("uploaded");
    hiddenArea.style.display = "inline-block";
    dropAreaInfo.style.display = "none";

    mapToButtons(obj);

    let allElementsHeight = getElementsHeight(".wrapper")
    parent.postMessage({ pluginMessage: { type: "change-size", allElementsHeight } }, "*");
  }

  ////////////////////////////////

  const onReaderLoad = (e) => {
    clearTheData();
    try {
      const obj = checkforNestedObj(JSON.parse(e.target.result))
      fileName.innerHTML = fileInput.files[0].name;

      dropAreaNotUploaded.style.display = "none";
      dropAreaUploaded.style.display = "flex";
      dropArea.classList.add("uploaded");
      hiddenArea.style.display = "inline-block";
      dropAreaInfo.style.display = "none";

      mapToButtons(obj);

      let allElementsHeight = getElementsHeight(".wrapper")
      parent.postMessage({ pluginMessage: { type: "change-size", allElementsHeight } }, "*");
    } catch(error) {
      alert("Seems like is something wrong with your JSON file. Please check it again");
    }
  };

  ////////////////////////////////

  const createStringButton = (item, obj) => {
    let button = document.createElement("button");
    button.innerHTML = item;
    button.classList.add("btn");
    button.classList.add("btn-secondary");
    button.style.cssText = "margin-right: 8px; margin-bottom: 8px";
    stringActions.appendChild(button);
    button.onclick = (e) => {
      let buttonName = e.target.innerHTML;
      let newObj = !randomCheckbox.checked ? obj : shuffle(obj);

      if (stringTemplateCheckbox.checked) {
        parent.postMessage(
          {
            pluginMessage: { type: "string-template-text", newObj, buttonName }
          },
          "*"
        );
      } else if (byLayerNameCheckbox.checked) {
        parent.postMessage(
          {
            pluginMessage: { type: "by-layer-name-text", newObj, buttonName }
          },
          "*"
        );
      } else {
        parent.postMessage(
          { pluginMessage: { type: "selected-text", newObj, buttonName } },
          "*"
        );
      }
    };
  };

  const mapToButtons = (obj) => {
    // map keys inside the first array item
    Object.keys(obj[0]).map((item, i) => {
      let val = obj[0][item];
      actionAreaString.style.display = "inline-block";
      createStringButton(item, obj);
    });
  };

  ////////////////////////////////

  const onChange = (e) => {
    var reader = new FileReader();
    reader.onload = onReaderLoad;
    reader.readAsText(e.target.files[0]);
  };

  const onHover = (e) => {
    console.log(e)
  }

  fileInput.addEventListener("change", onChange);
  showFileStructure.addEventListener("onmousemove", onHover);

  ///////////////////////////////

  document.getElementById("reset-file-button").onclick = () => {
    fileInput.value = "";
    dropAreaNotUploaded.style.display = "flex";
    dropAreaUploaded.style.display = "none";
    dropArea.classList.remove("uploaded");
    clearTheData();
    parent.postMessage(
      { pluginMessage: { type: "reset" } },
      "*"
    );
  };
</script>
