<!-- MAIN -->
<main class="wrapper">
  <!-- DROP AREA -->
  <div id="drop-area">
    <div style="margin: auto; width: 100%;">
      <div id="drop-area-not-uploaded">

        <svg id="logo" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 175 81">
          <defs/>
          <path fill="#0038FF" d="M38.855 32.54c-2.37 0-4.545-.36-6.525-1.08-1.95-.75-3.51-1.845-4.68-3.285-1.17-1.44-1.755-3.18-1.755-5.22l.045-.99h6.615l-.045.72c0 1.32.585 2.37 1.755 3.15 1.17.78 2.805 1.17 4.905 1.17 2.22 0 3.825-.285 4.815-.855.99-.6 1.485-1.395 1.485-2.385 0-.87-.33-1.59-.99-2.16-.63-.6-1.44-1.065-2.43-1.395-.96-.36-2.295-.78-4.005-1.26-2.43-.69-4.395-1.35-5.895-1.98-1.5-.63-2.79-1.56-3.87-2.79-1.08-1.26-1.62-2.91-1.62-4.95 0-2.82 1.14-4.965 3.42-6.435C32.36 1.325 35.39.59 39.17.59c3.57 0 6.48.765 8.73 2.295 2.28 1.5 3.42 3.765 3.42 6.795v.54h-6.48v-.405c0-1.14-.525-2.04-1.575-2.7-1.02-.66-2.415-.99-4.185-.99-1.89 0-3.345.255-4.365.765-.99.51-1.485 1.215-1.485 2.115 0 .69.3 1.29.9 1.8.6.48 1.35.885 2.25 1.215.9.3 2.175.675 3.825 1.125 2.46.66 4.47 1.32 6.03 1.98 1.59.63 2.955 1.575 4.095 2.835 1.14 1.26 1.71 2.91 1.71 4.95 0 3.3-1.185 5.73-3.555 7.29-2.34 1.56-5.55 2.34-9.63 2.34zM10.745 32.54c-3.42 0-6.045-.78-7.875-2.34C1.04 28.64.125 26.345.125 23.315V21.38h6.48v1.845c0 1.23.345 2.175 1.035 2.835.72.66 1.755.99 3.105.99 1.32 0 2.31-.33 2.97-.99.66-.66.99-1.605.99-2.835V1.13h6.57v22.185c0 3.03-.9 5.325-2.7 6.885-1.8 1.56-4.41 2.34-7.83 2.34z"/>
          <path fill="#0038FF" fill-rule="evenodd" d="M60.005 28.58c2.73 2.64 6.57 3.96 11.52 3.96 4.98 0 8.834-1.32 11.564-3.96 2.73-2.67 4.096-6.675 4.096-12.015 0-5.34-1.365-9.33-4.096-11.97C80.36 1.925 76.505.59 71.525.59c-4.95 0-8.79 1.335-11.52 4.005-2.73 2.64-4.096 6.63-4.096 11.97 0 5.34 1.366 9.345 4.096 12.015zm18.18-4.095c-1.5 1.68-3.72 2.52-6.66 2.52s-5.16-.84-6.66-2.52c-1.5-1.71-2.25-4.125-2.25-7.245v-1.35c0-3.12.75-5.52 2.25-7.2 1.5-1.71 3.72-2.565 6.66-2.565s5.16.855 6.66 2.565c1.53 1.68 2.294 4.08 2.294 7.2v1.35c0 3.12-.764 5.535-2.294 7.245z" clip-rule="evenodd"/>
          <path fill="#0038FF" d="M92.059 1.13h6.345l11.88 16.785c.36.51.96 1.515 1.8 3.015l.225-.135-.135-2.61V1.13h6.345V32h-6.345l-11.925-16.92c-.57-.81-1.155-1.8-1.755-2.97l-.225.135c.09 1.29.135 2.19.135 2.7V32h-6.345V1.13zM138.814 30.74c.96 1.2 2.55 1.8 4.77 1.8.66 0 1.365-.075 2.115-.225.78-.15 1.425-.315 1.935-.495V27.5h-2.16c-1.29 0-1.935-.645-1.935-1.935V13.37h4.095V8.33h-4.095V1.67h-4.995l-1.035 6.66h-2.97v5.04h2.835v12.825c0 1.83.48 3.345 1.44 4.545z"/>
          <path fill="#0038FF" fill-rule="evenodd" d="M162.754 32.54c-4.05 0-7.065-1.005-9.045-3.015-1.98-2.01-2.97-5.13-2.97-9.36 0-4.23.99-7.35 2.97-9.36 1.98-2.01 4.995-3.015 9.045-3.015s7.065 1.005 9.045 3.015c2.01 2.01 3.015 5.13 3.015 9.36 0 4.23-1.005 7.35-3.015 9.36-1.98 2.01-4.995 3.015-9.045 3.015zm0-5.04c2.01 0 3.465-.57 4.365-1.71.9-1.17 1.35-2.925 1.35-5.265v-.72c0-2.34-.45-4.08-1.35-5.22-.9-1.17-2.355-1.755-4.365-1.755-2.01 0-3.465.585-4.365 1.755-.87 1.14-1.305 2.88-1.305 5.22v.72c0 2.34.435 4.095 1.305 5.265.9 1.14 2.355 1.71 4.365 1.71z" clip-rule="evenodd"/>
          <path fill="#0038FF" d="M24.38 41.13H2.015V72H8.54V59.805h14.175V54.27H8.54v-7.605h15.84V41.13zM29.66 39.465h6.165v5.85H29.66v-5.85zM29.66 48.33h6.165V72H29.66V48.33z"/>
          <path fill="#0038FF" fill-rule="evenodd" d="M41.824 78.66c1.14 1.02 2.535 1.53 4.185 1.53h11.205c1.62 0 3.105-.3 4.455-.9 1.35-.6 2.415-1.455 3.195-2.565.78-1.11 1.17-2.385 1.17-3.825 0-1.89-.585-3.42-1.755-4.59s-2.625-1.755-4.365-1.755H49.16c-.45 0-.81-.12-1.08-.36a1.295 1.295 0 01-.405-.945c0-.42.15-.75.45-.99.33-.24.765-.36 1.305-.36h3.6c3.27 0 5.775-.72 7.515-2.16 1.77-1.44 2.655-3.405 2.655-5.895 0-2.22-.75-4.035-2.25-5.445 1.62-.36 2.865-1.035 3.735-2.025.9-1.02 1.35-2.355 1.35-4.005h-6.03c0 .57-.21 1.26-.63 2.07-.39.78-1.035 1.455-1.935 2.025-1.35-.45-2.94-.675-4.77-.675-3.36 0-5.955.72-7.785 2.16-1.8 1.44-2.7 3.405-2.7 5.895 0 2.85 1.155 4.98 3.465 6.39-1.23.3-2.235.825-3.015 1.575-.78.72-1.17 1.575-1.17 2.565 0 1.59.765 2.775 2.295 3.555-2.43 1.11-3.645 2.715-3.645 4.815 0 1.59.57 2.895 1.71 3.915zm14.13-19.935c-.75.66-1.845.99-3.285.99-1.44 0-2.535-.33-3.285-.99-.72-.69-1.08-1.65-1.08-2.88s.36-2.175 1.08-2.835c.75-.69 1.845-1.035 3.285-1.035 1.44 0 2.535.345 3.285 1.035.75.66 1.125 1.605 1.125 2.835s-.375 2.19-1.125 2.88zM59.06 75.33c-.51.39-1.155.585-1.935.585H48.71c-.69 0-1.26-.195-1.71-.585-.45-.39-.675-.9-.675-1.53 0-.6.225-1.095.675-1.485.48-.39 1.05-.585 1.71-.585h8.685c.69 0 1.26.18 1.71.54.48.36.72.87.72 1.53 0 .63-.255 1.14-.765 1.53z" clip-rule="evenodd"/>
          <path fill="#0038FF" d="M69.739 48.33h5.265l.45 3.105h.315c1.74-2.43 3.99-3.645 6.75-3.645 3 0 5.07 1.215 6.21 3.645h.36c1.8-2.43 4.14-3.645 7.02-3.645 2.25 0 4.035.66 5.355 1.98 1.35 1.32 2.025 3.435 2.025 6.345V72h-6.165V57.42c0-2.79-1.155-4.185-3.465-4.185-1.2 0-2.19.495-2.97 1.485-.78.96-1.17 2.16-1.17 3.6V72h-6.165V57.42c0-2.79-1.155-4.185-3.465-4.185-1.2 0-2.205.495-3.015 1.485-.78.96-1.17 2.16-1.17 3.6V72h-6.165V48.33z"/>
          <path fill="#0038FF" fill-rule="evenodd" d="M110.134 71.1c1.53.96 3.21 1.44 5.04 1.44 1.8 0 3.255-.255 4.365-.765 1.14-.54 2.145-1.32 3.015-2.34h.27c.3.99.855 1.755 1.665 2.295.84.54 1.875.81 3.105.81 1.41 0 2.595-.24 3.555-.72V67.5h-1.26c-.45 0-.825-.12-1.125-.36-.3-.27-.45-.675-.45-1.215v-10.44c0-2.49-.81-4.395-2.43-5.715-1.59-1.32-4.005-1.98-7.245-1.98-2.91 0-5.25.6-7.02 1.8-1.74 1.2-2.61 2.79-2.61 4.77 0 .48.015.81.045.99h5.94v-.675c0-.57.285-1.065.855-1.485.6-.42 1.59-.63 2.97-.63 1.29 0 2.16.285 2.61.855.48.57.72 1.38.72 2.43v1.665c-4.56 0-8.085.645-10.575 1.935-2.49 1.26-3.735 3.405-3.735 6.435 0 2.52.765 4.26 2.295 5.22zm10.8-4.86c-.81.96-2.085 1.44-3.825 1.44-1.02 0-1.785-.225-2.295-.675-.48-.45-.72-1.05-.72-1.8 0-2.4 2.685-3.6 8.055-3.6v.72c0 1.62-.405 2.925-1.215 3.915zM148.784 57.772c.416.248.936.372 1.56.372s1.14-.128 1.548-.384c.416-.256.732-.692.948-1.308.224-.624.336-1.48.336-2.568s-.112-1.94-.336-2.556c-.216-.624-.532-1.064-.948-1.32-.408-.256-.924-.384-1.548-.384s-1.144.128-1.56.384c-.408.248-.724.684-.948 1.308-.216.624-.324 1.48-.324 2.568s.108 1.944.324 2.568c.224.624.54 1.064.948 1.32zm2.268-1.224c-.16.168-.396.252-.708.252-.312 0-.552-.084-.72-.252-.16-.176-.272-.44-.336-.792-.056-.352-.084-.836-.084-1.452v-.84c0-.616.028-1.1.084-1.452.064-.352.176-.612.336-.78.168-.176.408-.264.72-.264s.548.088.708.264c.168.168.28.428.336.78.064.352.096.836.096 1.452v.84c0 .616-.032 1.1-.096 1.452-.056.352-.168.616-.336.792z" clip-rule="evenodd"/>
          <path fill="#0038FF" d="M138.02 56.656h1.932V51.76h-1.944v-1.02c.36-.04.8-.152 1.32-.336.528-.184 1-.396 1.416-.636h.852v6.888h1.764V58h-5.34v-1.344zM144.508 56.356h1.656V58h-1.656v-1.644z"/>
        </svg>

        <svg id="klammern" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 147 203">
          <defs/>
          <path fill="url(#paint0_linear)" d="M66.64 203c-23.887 0-45.644-6.724-45.644-33.606v-44.052c0-10.536-12.475-13.624-20.996-13.624V91.282c8.662 0 20.996-2.875 20.996-13.624V33.606C20.996 6.026 43.768 0 66.64 0v15.895c-9.715 0-21.587 3.23-21.909 14.76 0 15.059-1.004 30.138-1.598 45.186-.606 16.001-10.207 24.524-26.017 24.524v2.27c15.845 0 25.421 8.502 26.017 24.524.594 15.048 1.598 30.127 1.598 45.187.152 9.839 7.455 14.759 21.909 14.759V203z"/>
          <path fill="url(#paint1_linear)" d="M80.36 187.105c14.454 0 21.681-4.92 21.681-14.759.546-15.045 1.597-30.13 1.597-45.187.605-15.943 10.508-24.524 26.246-24.524v-2.27c-15.875 0-25.635-8.412-26.246-24.524 0-15.057-1.051-30.142-1.597-45.187 0-11.578-12.046-14.76-21.681-14.76V0c22.746 0 45.644 6.145 45.644 33.606v44.052c0 10.864 12.223 13.624 20.996 13.624v20.436c-8.629 0-20.996 2.972-20.996 13.624v44.052c0 27.461-22.898 33.606-45.644 33.606v-15.895z"/>
          <defs>
            <linearGradient id="paint0_linear" x1="82.102" x2="48.439" y1="118.147" y2="96.612" gradientUnits="userSpaceOnUse">
              <stop stop-color="#FF9179"/>
              <stop offset="1" stop-color="#06F"/>
            </linearGradient>
            <linearGradient id="paint1_linear" x1="82.102" x2="48.439" y1="118.147" y2="96.612" gradientUnits="userSpaceOnUse">
              <stop stop-color="#FF9179"/>
              <stop offset="1" stop-color="#06F"/>
            </linearGradient>
          </defs>
        </svg>
        
        <label class="btn btn-electric">
          <input id="file-input" type="file" multiple />
          Select JSON file
        </label>
      </div>

      <div id="drop-area-uploaded">
        <div id="file-name-wrap">
          <svg
            style="width: 16px; height: 20px;"
            fill="none"
            viewBox="0 0 16 20"
          >
            <path
              fill="#1BC47D"
              stroke="#1BC47D"
              d="M.5.5h10.777L15.5 5.192V19.5H.5V.5z"
            />
            <path stroke="#fff" d="M4.198 9.91l2.72 2.72 4.693-4.694" />
          </svg>
          <span class="body-text" id="file-name">file</span>
        </div>
        <button class="btn btn-secondary" id="reset-file-button">Reset</button>
      </div>
    </div>
  </div>
  <!-- INFO -->
  <div id="drop-area-info">
    <p class="caption-text" style="margin-top: 16px; margin-bottom: 16px;">
      Your JSON file should have a
      <span id="show-file-structure">certain structure</span> to be readable.
    </p>
    <img id="drop-area-info-image" src="https://cdn.glitch.com/604ccd24-6c39-4492-b5ee-72a22eb071c0%2Fjson-example.png"/>
  </div>
  <!-- HIDDEN AREA -->
  <section id="hidden-area">
    <!-- ACTIONS AREA -->
    <section class="section" id="actions-area">
      <div id="actions-area-string">
        <h2 class="small-header-text">String items</h2>
        <div id="string-actions"></div>
      </div>
    </section>
    <!-- FIND IN SECTIONS AREA -->
    <section class="section" id="options-area">
      <h2 class="small-header-text">Find and populate</h2>

      <section class="sub-section">
        <div class="radio-btn">
          <input
            type="radio"
            checked
            name="populate-mode"
            id="only-selected-chk"
          />
          <label for="only-selected-chk" class="body-text"
            >Only selected layers</label
          >
        </div>
        <p class="caption-text">
          Replaces text only for directly selected text layers.
        </p>
      </section class="sub-section">

      <section class="sub-section">
        <div class="radio-btn">
          <input type="radio" name="populate-mode" id="layer-name-chk" />
          <label for="layer-name-chk" class="body-text"
            >Find by layer name</label
          >
        </div>
        <p class="caption-text">
          You can populate layers deeply nested in any group or frame. To do so, manually rename the layer you want to populate so that it matches the name in the JSON file.
        </p>
      </section>

      <section>
        <div class="radio-btn">
          <input type="radio" name="populate-mode" id="string-template-chk" />
          <label for="string-template-chk" class="body-text"
            >Find by string templates</label
          >
        </div>
        <p class="caption-text">
          Select frames or groups that contents text layers with string templates. Replaces only the contents of a string in {braces}.
        </p>
      </section>
    </section>
    <!-- RANDOM AREA -->
    <section class="section" id="random-area" style="padding-bottom: 0">
      <div class="checkbox-btn">
        <input type="checkbox" id="random-paste-chk" />
        <label for="random-paste-chk" class="body-text">Random order</label>
      </div>
      <p class="caption-text" style="margin-bottom: 0">
        All selected items will be filled in a random order.
      </p>
    </section>
  </section>
</main>

<!-- STYLES -->
<style>
  /* ///////////////////////////// */
  /*/////////// GENERAL ///////////*/
  /* ///////////////////////////// */
  :root {
    /* Animation */
    --default-transition: 0.1s ease;
    --middle-transition: 0.2s ease;
    /* Main colors */
    --pink-clr: #FFCDCD;
    --electro-blue-clr: #0038FF;
    --main-clr: #18a0fb;
    --main-dark-clr: #1290e4;
    /* Neutral colors */
    --n-white-clr: #fff;
    --n-light-clr: #F9F9F9;
    --n-semilight-clr: #DBDBDB;
    --n-semidark-clr: #7C7C7C;
    --n-dark-clr: #333;
    --n-black-clr: #000;
    /* State colors */
    --success-light-clr: #F5FDF9;
    --success-main-clr: #5CCF89;
  }
  html {
    box-sizing: border-box;
  }
  *, *:before, *:after {
    box-sizing: border-box;
  }
  body {
    overflow-x: hidden;
    user-select: none;
  }
  input[type="checkbox"],
  input[type="radio"] {
    display: none;
  }
  /* ///////////////////////////// */
  /*/////////// CLASSES ///////////*/
  /* ///////////////////////////// */
  .wrapper {
    display: flex;
    flex-direction: column;
  }
  .body-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
  }
  .caption-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
    color: var(--n-semidark-clr);
  }
  .small-header-text {
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-size: 11px;
    font-weight: 600;
    margin: 0 0 16px;
  }
  /* BUTTON */
  .btn {
    display: inline-block;
    flex-shrink: 0;
    margin: 1px 0 1px 0;
    padding: 6px 16px;
    border: 2px solid transparent;
    border-radius: 6px;
    outline: none;
    font-family: "Inter", sans-serif;
    line-height: 16px;
    font-weight: normal;
    font-size: 11px;
    letter-spacing: 0.01em;
    transition: all var(--default-transition);
  }
  /*  */
  .btn-electric {
    color: var(--n-white-clr);
    background-color: var(--electro-blue-clr);
  }
  .btn-primary {
    color: var(--n-white-clr);
    background-color: var(--main-clr);
  }
  .btn-primary:hover {
    background-color: var(--main-dark-clr);
  }
  /*  */
  .btn-secondary {
    color: var(--n-dark-clr);
    background-color: transparent;
    border: 1px solid var(--n-dark-clr);
  }
  .btn-secondary:hover {
    border: 1px solid var(--n-semidark-clr);
  }
  /* RADIO */
  .radio-btn label {
    padding-left: 22px;
    display: inline-block;
    position: relative;
    line-height: 1.3;
  }
  .radio-btn input[type="radio"] + label:before {
    content: "";
    display: block;
    width: 12px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid var(--n-dark-clr);
    background: var(--n-white-clr);;
    border-radius: 50px;
  }
  .radio-btn input[type="radio"]:checked + label:after {
    content: "";
    display: block;
    width: 6px;
    height: 6px;
    background: var(--n-dark-clr);
    position: absolute;
    border-radius: 50%;
    top: 3px;
    left: 3px;
  }
  /* CHECKBOX */
  .checkbox-btn label {
    padding-left: 34px;
    line-height: 1.3;
    display: inline-block;
    position: relative;
  }
  .checkbox-btn input[type="checkbox"] + label:before {
    content: "";
    display: block;
    width: 24px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid var(--n-dark-clr);
    background: var(--n-white-clr);
    border-radius: 50px;
    transition: all var(--middle-transition);
  }
  .checkbox-btn input[type="checkbox"] + label:after {
    content: "";
    display: block;
    width: 12px;
    height: 12px;
    position: absolute;
    top: 0;
    left: 0;
    border: 1px solid var(--n-dark-clr);
    background: var(--n-white-clr);
    border-radius: 50px;
    transition: all var(--middle-transition);
  }
  .checkbox-btn input[type="checkbox"]:checked + label:before {
    background: #000;
  }
  .checkbox-btn input[type="checkbox"]:checked + label:after {
    left: 12px;
  }
  /* //////////////////////////// */
  /*////////// SECTIONS //////////*/
  /* //////////////////////////// */
  .divider {
    margin: 0 -16px;
  }
  /*  */
  .section {
    user-select: none;
    padding: 20px 8px 16px;
  }
  .sub-section {
    user-select: none;
    margin: 0 0 24px;
  }
  /* //////////////////////////// */
  /*//////////// ID'S ////////////*/
  /* //////////////////////////// */
  #klammern {
    width: 146px;
    height: 200px;
    top: -68px;
    left: -24px;
    position: absolute;
    z-index: 0;
  }
  #logo {
    z-index: 999;
    position: relative;
    margin-bottom: 32px;
    width: 176px;
  }
  #show-file-structure {
    color: var(--n-black-clr);
    text-decoration: underline;
    text-decoration-style: dotted;
  }
  /* ///////////////////////////// */
  /*//////////// AREAS ////////////*/
  /* ///////////////////////////// */
  #drop-area {
    overflow: hidden;
    position: relative;
    padding: 32px 32px 24px;
    min-height: 140px;
    margin: -8px -16px 0;
    background-color: var(--pink-clr);
    display: flex;
    flex-direction: column;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.12);
  }
  #drop-area.uploaded {
    background-color: var(--success-light-clr);
    min-height: auto;
  }
  /*  */
  #drop-area-not-uploaded {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: all var(--middle-transition);
  }
  #drop-area-not-uploaded input[type="file"] {
    display: none;
  }
  #drop-area-not-uploaded > span {
    color: var(--n-dark-clr);
    margin-bottom: 12px;
  }
  /*  */
  #file-name-wrap {
    display: flex;
    align-items: center;
  }
  #file-name {
    color: var(--n-dark-clr);
    margin-left: 10px;
    margin-right: 20px;
  }
  /*  */
  #drop-area-uploaded {
    display: none;
    width: 100%;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  /*  */
  #drop-area-info {
    font-family: "Inter", sans-serif;
    padding: 0 8px;
  }
  /*  */
  #drop-area-info-image {
    display: none;
    width: 100%;
    height: 320px;
    margin-top: 8px;
  }
  /*  */
  #options-area {
    margin: 0 -8px;
    padding: 16px 16px 16px;
    background: var(--n-light-clr);
    border-top: 1px solid var(--n-semilight-clr);
    border-bottom: 1px solid var(--n-semilight-clr);
  }
  /*  */
  #hidden-area {
    display: none;
  }
</style>

<!-- SCRIPTS -->
<script>
  // Variales
  const dropArea = document.getElementById("drop-area");
  const dropAreaInfo = document.getElementById("drop-area-info");
  const fileInput = document.getElementById("file-input");
  const fileName = document.getElementById("file-name");
  //
  const hiddenArea = document.getElementById("hidden-area");
  const actionArea = document.getElementById("actions-area");
  const actionAreaString = document.getElementById("actions-area-string");
  const stringActions = document.getElementById("string-actions");
  //
  const randomArea = document.getElementById("random-area");
  const randomCheckbox = document.getElementById("random-paste-chk");
  //
  const dropAreaNotUploaded = document.getElementById("drop-area-not-uploaded");
  const dropAreaUploaded = document.getElementById("drop-area-uploaded");
  //
  const stringTemplateCheckbox = document.getElementById("string-template-chk");
  const byLayerNameCheckbox = document.getElementById("layer-name-chk");
  //
  const showFileStructure = document.getElementById("show-file-structure");
  const fileStructureImage = document.getElementById("drop-area-info-image");

  ////////////////////////////////////////////
  ////////////// Util functions //////////////
  ////////////////////////////////////////////

  const getElementsHeight = (el) => {
    const arr = document.querySelector(el).children
    let frameHeight = 0
    for (var item of arr) {
      frameHeight = frameHeight + item.getBoundingClientRect().height
    }
    return Math.round(frameHeight)
  }

  const IsJsonString = (str) => {
    try {
      let json = JSON.parse(str);
      return typeof json === "object";
    } catch (e) {
      return false;
    }
  };

  const shuffle = (arr) => {
    const newArr = arr.slice();
    for (let i = newArr.length - 1; i > 0; i--) {
      const rand = Math.floor(Math.random() * (i + 1));
      [newArr[i], newArr[rand]] = [newArr[rand], newArr[i]];
    }
    return newArr;
  };

  const checkforNestedObj = (json) => {
    let newJSONArray = []

    json.map((JSONitem, g) => {
      let newSubObj = {}
      const firstArrayLevel = Object.values(JSONitem)
      firstArrayLevel.map((item, i) => {
        if (typeof item === "object") {
          const firstLevelObjectKeys = Object.keys(json[g])
          const firstLevelObjectValues = Object.values(json[g])
          const secondLevelObjectKeys = Object.keys(item)

          secondLevelObjectKeys.map((secondLevelKey, j) => {
            const secondLevelValues = Object.values(item)[j]

            if (typeof secondLevelValues === "object") {
              Object.keys(secondLevelValues).map((thirdLevelKey, f) => {
                newSubObj[`${firstLevelObjectKeys[i]}-${secondLevelKey}-${thirdLevelKey}`] = firstLevelObjectValues[i][secondLevelKey][thirdLevelKey]
              })
            } else {
              newSubObj[`${firstLevelObjectKeys[i]}-${secondLevelKey}`] = firstLevelObjectValues[i][secondLevelKey]
            }
          })
        } else {
          newSubObj[Object.keys(JSONitem)[i]] = item
        }
      })
      newJSONArray.push(newSubObj)
    })
    return newJSONArray
  }

  const clearTheData = () => {
    hiddenArea.style.display = "none";
    dropAreaInfo.style.display = "inline-block";
    stringActions.textContent = "";
  };

  const loadJSON = (obj) => {
    fileName.innerHTML = fileInput.files[0].name;

    dropAreaNotUploaded.style.display = "none";
    dropAreaUploaded.style.display = "flex";
    dropArea.classList.add("uploaded");
    hiddenArea.style.display = "inline-block";
    dropAreaInfo.style.display = "none";

    mapToButtons(obj);

    let frameHeight = getElementsHeight(".wrapper")
    parent.postMessage({ pluginMessage: { type: "change-size", frameHeight } }, "*");
  }

  /////////////////////////////////////////////
  //////////// Load and read file /////////////
  /////////////////////////////////////////////

  const onReaderLoad = (e) => {
    clearTheData();
    try {
      const obj = checkforNestedObj(JSON.parse(e.target.result))
      fileName.innerHTML = fileInput.files[0].name;

      dropAreaNotUploaded.style.display = "none";
      dropAreaUploaded.style.display = "flex";
      dropArea.classList.add("uploaded");
      hiddenArea.style.display = "inline-block";
      dropAreaInfo.style.display = "none";

      mapToButtons(obj);

      let frameHeight = getElementsHeight(".wrapper")
      parent.postMessage({ pluginMessage: { type: "change-size", frameHeight } }, "*");
    } catch(error) {
      alert("Seems like is something wrong with your JSON file. Please check it again");
    }
  };

  ////////////////////////////////////////////
  ////////////// Create buttons //////////////
  ////////////////////////////////////////////

  const createStringButton = (item, obj) => {
    let button = document.createElement("button");
    button.innerHTML = item;
    button.classList.add("btn");
    button.classList.add("btn-secondary");
    button.style.cssText = "margin-right: 8px; margin-bottom: 8px";
    stringActions.appendChild(button);
    button.onclick = (e) => {
      let buttonName = e.target.innerHTML;
      let newObj = !randomCheckbox.checked ? obj : shuffle(obj);

      if (stringTemplateCheckbox.checked) {
        parent.postMessage(
          {
            pluginMessage: { type: "string-template-text", newObj, buttonName }
          },
          "*"
        );
      } else if (byLayerNameCheckbox.checked) {
        parent.postMessage(
          {
            pluginMessage: { type: "by-layer-name-text", newObj, buttonName }
          },
          "*"
        );
      } else {
        parent.postMessage(
          { pluginMessage: { type: "selected-text", newObj, buttonName } },
          "*"
        );
      }
    };
  };

  const mapToButtons = (obj) => {
    // map keys inside the first array item
    Object.keys(obj[0]).map((item, i) => {
      let val = obj[0][item];
      actionAreaString.style.display = "inline-block";
      createStringButton(item, obj);
    });
  };

  ////////////////////////////////////////////
  ///////////////// Handlers /////////////////
  ////////////////////////////////////////////

  const onChange = (e) => {
    var reader = new FileReader();
    reader.onload = onReaderLoad;
    reader.readAsText(e.target.files[0]);
  };

  let isShowFileStructure = true

  const showFileStructureClick = (e) => {
    if (isShowFileStructure) {
      fileStructureImage.style.display = "block";

      let frameHeight = getElementsHeight(".wrapper")
      parent.postMessage({ pluginMessage: { type: "change-size", frameHeight } }, "*");
      isShowFileStructure = false
    } else {
      fileStructureImage.style.display = "none";

      let frameHeight = getElementsHeight(".wrapper") - 12
      parent.postMessage({ pluginMessage: { type: "change-size", frameHeight } }, "*");
      isShowFileStructure = true
    }
    
  }

  fileInput.addEventListener("change", onChange);
  showFileStructure.addEventListener("click", showFileStructureClick);

  ////////////////////////////////////////////
  ///////////////// Reset file ////////////////
  ////////////////////////////////////////////

  document.getElementById("reset-file-button").onclick = () => {
    fileInput.value = "";
    dropAreaNotUploaded.style.display = "flex";
    dropAreaUploaded.style.display = "none";
    fileStructureImage.style.display = "none";
    isShowFileStructure = true
    dropArea.classList.remove("uploaded");
    clearTheData();
    let frameHeight = getElementsHeight(".wrapper") - 12
    parent.postMessage(
      { pluginMessage: { type: "reset", frameHeight } },
      "*"
    );
  };
</script>
