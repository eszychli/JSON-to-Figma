<!-- DROP AREA -->
<main class="wrapper">
  <section class="section">
    <div id="drop-area">
      <input id="file-input" type="file" multiple />
      <button id="reset-file-button">clear</button>
    </div>
    <div id="drop-area-info">
    <p >
      Your JSON file should have a
      <a href="#" target="_blank">certain structure</a> to be readable.
    </p>
    <div>
  </section>
  <!-- ACTIONS AREA -->
  <section class="section" id="actions-area">
    <div class="sub-section">
      <h2>String items</h2>
      <div id="string-actions"></div>
    </div>
    <div class="sub-section">
      <h2>Image items</h2>
      <div id="image-actions"></div>
    </div>
  </section>
  <!-- RANDOM AREA -->
  <section class="section" id="random-area">
    <hr class="divider" />
    <div>
      <input type="checkbox" id="random-paste" />
      <label for="random-paste">Random order</label>
    </div>
    <p>
      All selected items will be filled in the same order as in the JSON file
      but you can switch this feature off with this switcher.
    </p>
  </section>
</main>

<!-- STYLES -->
<style>
  .wrapper {
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  .divider {
    margin: 0 -16px;
  }
  .section {
    user-select: none;
    margin: 8px;
    box-sizing: border-box;
  }
  #drop-area {
    border: 1px solid;
    padding: 20px;
    margin: 0 -16px;
  }
  #drop-area.highlight {
    border-color: #f45;
  }
  #actions-area {
    display: none;
  }
  #random-area {
    display: none;
  }
</style>

<!-- SCRIPTS -->
<script>
  // Variales
  const dropArea = document.getElementById("drop-area");
  const dropAreaInfo = document.getElementById("drop-area-info");
  const fileInput = document.getElementById("file-input");
  //
  const actionArea = document.getElementById("actions-area");
  const stringBtnArea = document.getElementById("string-actions");
  const imageBtnArea = document.getElementById("image-actions");
  //
  const randomArea = document.getElementById("random-area"); 
  const randomCheckbox = document.getElementById("random-paste");

  ////////////////////////////////

  // Util functions
  const IsJsonString = (str) => {
    try {
      let json = JSON.parse(str);
      return typeof json === "object";
    } catch (e) {
      return false;
    }
  };

  const shuffle = (arr) => {
    const newArr = arr.slice();
    for (let i = newArr.length - 1; i > 0; i--) {
      const rand = Math.floor(Math.random() * (i + 1));
      [newArr[i], newArr[rand]] = [newArr[rand], newArr[i]];
    }
    return newArr;
  };

  const clearTheData = () => {
    actionArea.style.display = "none";
    randomArea.style.display = "none";
    dropAreaInfo.style.display = "inline-block";
    stringBtnArea.textContent = "";
    imageBtnArea.textContent = "";
  };

  ////////////////////////////////

  // Drag&Drop functions
  const highlight = (e) => {
    dropArea.classList.add("highlight");
  };

  const unhighlight = (e) => {
    dropArea.classList.remove("highlight");
  };

  const preventDefaults = (e) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = (e) => {
    fileInput.files = e.dataTransfer.files;
  };

  const onReaderLoad = (e) => {
    clearTheData();
    var obj = JSON.parse(e.target.result);
    if (IsJsonString(e.target.result)) {
      actionArea.style.display = "inline-block";
      randomArea.style.display = "inline-block";
      dropAreaInfo.style.display = "none";
      mapToButtons(obj);
      parent.postMessage({ pluginMessage: { type: "change-size" } }, "*");
    } else {
      console.log(false);
    }
  };

  // Listeners
  dropArea.addEventListener("dragenter", highlight, false);
  dropArea.addEventListener("dragover", highlight, false);
  dropArea.addEventListener("dragleave", unhighlight, false);
  dropArea.addEventListener("drop", handleDrop, false);

  ["dragenter", "dragover", "dragleave", "drop"].forEach((e) => {
    dropArea.addEventListener(e, preventDefaults, false);
  });

  ["dragenter", "dragover"].forEach((e) => {
    dropArea.addEventListener(e, highlight, false);
  });

  ["dragleave", "drop"].forEach((e) => {
    dropArea.addEventListener(e, unhighlight, false);
  });

  ////////////////////////////////

  const createStringButton = (item, obj) => {
    let button = document.createElement("button");
    button.innerHTML = item;
    stringBtnArea.appendChild(button);
    button.onclick = (e) => {
      let buttonName = e.target.innerHTML;
      let newObj = obj;

      if (randomCheckbox.checked) {
        // console.log(obj);
        oldObj = [...obj];
        newObj = shuffle(oldObj);

        parent.postMessage(
          { pluginMessage: { type: "selected-text", newObj, buttonName } },
          "*"
        );
      } else {
        parent.postMessage(
          { pluginMessage: { type: "selected-text", newObj, buttonName } },
          "*"
        );
      }
    };
  };

  async function getDataArr(obj, buttonName) {
    obj.map((item, i) => {
      var url = item[buttonName];
      var xmlHTTP = new XMLHttpRequest();
      xmlHTTP.open("GET", url, true);
      xmlHTTP.responseType = "arraybuffer";
      xmlHTTP.onload = function(e) {
        let response = new Uint8Array(this.response);
        parent.postMessage(
          {
            pluginMessage: {
              type: "selected-image",
              obj,
              response,
              i
            }
          },
          "*"
        );
      };
      xmlHTTP.send();
    });
  }

  const createImgButton = (item, obj) => {
    let button = document.createElement("button");
    button.innerHTML = item;
    imageBtnArea.appendChild(button);

    button.onclick = (e) => {
      let buttonName = e.target.innerHTML;
      let newObj = obj;

      if (randomCheckbox.checked) {
        oldObj = [...obj];
        newObj = shuffle(oldObj);
        getDataArr(newObj, item);
      } else {
        getDataArr(newObj, item);
      }
    };
  };

  const mapToButtons = (obj) => {
    // map keys inside tthe first array item
    Object.keys(obj[0]).map((item, i) => {
      let val = obj[0][item];
      let isPicture = val.toUpperCase().startsWith("HTTPS")
        ? createImgButton(item, obj)
        : createStringButton(item, obj);
    });
  };

  ////////////////////////////////

  const onChange = (e) => {
    var reader = new FileReader();
    reader.onload = onReaderLoad;
    reader.readAsText(e.target.files[0]);
  };

  document.getElementById("file-input").addEventListener("change", onChange);

  ///////////////////////////////

  document.getElementById("reset-file-button").onclick = () => {
    fileInput.value = "";
    clearTheData();
  };
</script>
