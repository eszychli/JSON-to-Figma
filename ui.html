<!-- DROP AREA -->
<section class="section">
  <div id="drop-area">
    <input id="file-input" type="file" multiple />
    <button id="reset-file-button">clear</button>
  </div>
  <p>
    Your JSON file should have a certain structure to be readable.
  </p>
</section>
<!-- ACTIONS AREA -->
<section class="section">
  <hr />
  <div id="actions-area">
    <h2>String items</h2>
    <div id="string-actions"></div>
    <h2>Image items</h2>
    <div id="image-actions"></div>
  </div>
</section>
<!-- BIND AREA -->
<section class="section" id="bind-area">
  <hr />
  <div>
    <input type="checkbox" id="auto-bind" />
    <label for="auto-bind">Automatic bind</label>
  </div>
  <p>
    You can populate layers deeply nested in a group. To do so, manualy rename a
    layer you want to populate â€” the name of the layer and key in the JSON file
    must match.
  </p>
</section>

<!-- STYLES -->
<style>
  .section {
    user-select: none;
  }
  #drop-area {
    border: 1px solid;
    padding: 20px;
  }
  #drop-area.highlight {
    border-color: #f45;
  }
</style>

<!-- SCRIPTS -->
<script>
  // Helper functions
  const IsJsonString = str => {
    try {
      let json = JSON.parse(str);
      return typeof json === 'object';
    } catch (e) {
      return false;
    }
  };

  // const isPicture = obj => {
  //   obj.map(item => {
  //     Object.values(item).map(val => {
  //       if (val.endsWith('.jpeg')) {
  //         return true;
  //       } else {
  //         return false;
  //       }
  //     });
  //   });
  // };

  // Variales
  const actionArea = document.getElementById('actions-area');
  const stringBtnArea = document.getElementById('string-actions');
  const imageBtnArea = document.getElementById('image-actions');
  const dropArea = document.getElementById('drop-area');
  const fileInput = document.getElementById('file-input');

  // Drag&Drop functions
  const highlight = e => {
    dropArea.classList.add('highlight');
  };

  const unhighlight = e => {
    dropArea.classList.remove('highlight');
  };

  const preventDefaults = e => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = e => {
    fileInput.files = e.dataTransfer.files;
  };

  const onReaderLoad = e => {
    var obj = JSON.parse(e.target.result);
    if (IsJsonString(e.target.result)) {
      mapToButtons(obj);
    } else {
      console.log(false);
    }
  };

  // Listeners
  dropArea.addEventListener('dragenter', highlight, false);
  dropArea.addEventListener('dragover', highlight, false);
  dropArea.addEventListener('dragleave', unhighlight, false);
  dropArea.addEventListener('drop', handleDrop, false);

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
    dropArea.addEventListener(e, preventDefaults, false);
  });

  ['dragenter', 'dragover'].forEach(e => {
    dropArea.addEventListener(e, highlight, false);
  });
  ['dragleave', 'drop'].forEach(e => {
    dropArea.addEventListener(e, unhighlight, false);
  });

  ////////////////////////////////

  const createStringButton = (item, obj) => {
    let button = document.createElement('button');
    button.innerHTML = item;
    stringBtnArea.appendChild(button);
    button.onclick = e => {
      let buttonName = e.target.innerHTML;
      parent.postMessage(
        { pluginMessage: { type: 'selected', obj, buttonName } },
        '*'
      );
    };
  };

  const createImgButton = (item, obj) => {
    let button = document.createElement('button');
    button.innerHTML = item;
    imageBtnArea.appendChild(button);
    button.onclick = e => {
      let buttonName = e.target.innerHTML;
      parent.postMessage(
        { pluginMessage: { type: 'selected', obj, buttonName } },
        '*'
      );
    };
  };

  const mapToButtons = obj => {
    // map keys inside tthe first array item
    Object.keys(obj[0]).map((item, i) => {
      let val = obj[0][item];
      let isPicture =
        val.toUpperCase().endsWith('.JPEG') ||
        val.toUpperCase().endsWith('.JPG') ||
        val.toUpperCase().endsWith('.PNG') ||
        val.toUpperCase().endsWith('.GIF')
          ? createImgButton(item, obj)
          : createStringButton(item, obj);
    });
  };

  ////////////////////////////////

  const onChange = e => {
    var reader = new FileReader();
    reader.onload = onReaderLoad;
    reader.readAsText(e.target.files[0]);
  };

  document.getElementById('file-input').addEventListener('change', onChange);

  ///////////////////////////////

  document.getElementById('reset-file-button').onclick = () => {
    fileInput.value = '';
    actionArea.textContent = '';
  };
</script>
